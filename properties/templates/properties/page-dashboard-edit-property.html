{% extends 'properties/index.html' %}
{% load static %}


{% block header %}
{% include 'properties/header-2.html' %}
{% endblock header %}
{% block title %}Home{% endblock %}
{% block content %}
<!-- Our Dashbord -->
{% include 'users/dashboard-nav-1.html' %}

<!-- Our Dashbord -->
<section class="our-dashbord dashbord bgc-alice-blue">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-2 dn-lg pl0"></div>
            <div class="col-xl-10">
                <div class="row">
                    {% include 'users/dashboard-nav.html' %}
                    <div class="col-lg-12 mb50">
                        <div class="breadcrumb_content">
                            <h2 class="breadcrumb_title">Edit Existing Property</h2>
                            <p class="">Ready to jump back in?</p>
                        </div>
                    </div>
                </div>

                <!--					form here-->
                <form class="contact_form" id="property_creation_form" name="contact_form"
                    action="{% url 'properties:create-listing' %}" method="post" novalidate>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="new_property_form">
                                <h4 class="title mb30">Contact Information</h4>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb30">
                                            {{form.name}}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="ui_kit_select_search add_new_property mb30">
                                            {{form.property_type}}
                                        </div>
                                    </div>
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            {{form.desc}}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="new_property_form">
                                <h4 class="title mb30">Additional</h4>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <div class="ui_kit_select_search add_new_property mb30">
                                            {{form.status}}
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="ui_kit_select_search add_new_property mb30">
                                            {{form.property_cat}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb20">
                                            {{form.no_rooms}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb30">
                                            {{form.no_baths}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb30">
                                            {{form.no_garages}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb30">
                                            {{form.year_built}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb30">
                                            {{form.compound_area}}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            {{form.property_area}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="new_property_form">
                                <h4 class="title mb30">Price</h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb30">
                                            {{form.price}}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb30">
                                            <input name="form_name" disabled class="form-control form_control"
                                                type="text" placeholder="Price Prefix ($)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="new_property_form">
                                <h4 class="title mb30">Location</h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="ui_kit_select_search add_new_property mb30">
                                            <select class="selectpicker" data-live-search="true" data-width="100%"
                                                title="Group">
                                                <!-- <option>Regions</option> -->
                                                <option data-tokens="City">City</option>
                                                <option data-tokens="Capital">District</option>
                                                <!-- <option data-tokens="State">State</option> -->
                                                <option data-tokens="Village">Village</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="ui_kit_select_search add_new_property mb30">
                                            {{form.district}}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mb30">
                                            <input name="location_area" id="location_area"
                                                class="form-control form_control" type="text"
                                                placeholder="Map Location">
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mb20">
                                            <div class="h550 bdrs3" id="map-canvas"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            {{form.lon}}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            {{form.lat}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="new_property_form">
                                <h4 class="mb30">Hightlights<a class="btn btn-lg btn-thm ml-4"
                                        onclick="document.getElementById('amenityForm').showModal()">Add Amenity</a>
                                </h4>
                                {{form.amenities}}
                            </div>
                            <div class="new_property_form">
                                <h4 class="title mb30">Media</h4>
                                <div class="row">
                                    
                                </div>
                            </div>
                            
                        </div>
                        <div class="text-right">
                            <button id="main-submit" class="btn btn-thm listing_save_btn" type="submit"
                                form="contact_form">Submit</button>
                        </div>
                    </div>
            </div>

            </form>

            <!-- amenity creation form -->
            <dialog id="amenityForm" style="border-radius: 8px; border-color: transparent;">
                <form name="am_form" id="am_form">
                    {% csrf_token %}
                    {{am_form}}
                    <div class="form pt-4">
                        <a id="am_btn" class="btn btn-lg btn-thm" form="#am_form" type="submit">Save</a>
                        <a class="btn dbxshadbtn-md btn-thm3 rounded"
                            onclick="document.getElementById('amenityForm').close()">X</a>
                    </div>
                </form>
            </dialog>

            <script>
                document.getElementById('main-submit').addEventListener("click", function (e) {
                    document.getElementById("property_creation_form").submit();
                })

                // Listen for when the amenity submit button is clicked
                // The button is part of a modal
                document.getElementById('am_btn').addEventListener("click", function (e) {
                    e.preventDefault();

                    $.ajax({
                        type: 'POST',
                        url: '{% url 'properties:create-amenity' %}',
                        data: {
                            amenity_name: $('#amenity_name').val(),
                            amenity_desc: $('#amenity_desc').val(),
                            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                        },

                        success: function () {
                            // Hide modal before showing sweet alert
                            document.getElementById("amenityForm").close();

                            // Show sweet alert
                            Swal.fire({
                                title: 'Good job!',
                                text: 'Your Amenity Creation Was Successful',
                                icon: 'success',
                                timer: 5000,
                                showConfirmButton: false,
                                showDenyButton: false,
                                showCancelButton: false,
                            });
                        },

                        error: function () {
                            document.getElementById("amenityForm").close();

                            Swal.fire({
                                title: 'Oops...',
                                text: 'An Error Occured! Amenity Creation Unsuccessful',
                                icon: 'error',
                                timer: 5500,
                                showConfirmButton: false,
                                showDenyButton: false,
                                showCancelButton: false,
                            });
                        },
                    });
                });

                // Function opens modal for Property Category
                function PopUp() {
                    document.getElementById("addForm").showModal();
                }

                // Function hides open modal for Property Category
                function HidePopUp() {
                    document.getElementById("addForm").close();
                }

            </script>

            </dialog>

            <div class="row mt50">
                <div class="col-lg-12">
                    <p class="mb0">Copyright © 2021 CreativeLayers. All Right Reserved.</p>
                </div>
            </div>
        </div>
    </div>
    </div>
</section>
<a class="scrollToHome" href="#"><i class="fa fa-angle-up"></i></a>

<!-- Wrapper End -->

<script>
    // Create auto complete variable
    let autocomplete;

    // Function handles auto completion event
    function onPlaceChanged() {
        var place = autocomplete.getPlace();

        if (!place.geometry) {
            document.getElementById('location_area').placeholder = 'Location Name';
        } else {
            codeAddress();
        }
    }

    var geocoder;
    var map;

    function initializeGeocoder() {
        autocomplete = new google.maps.places.Autocomplete(document.getElementById('location_area'), {
            types: ['establishment'],
            fields: ['geometry', 'name', 'address_components']
        });

        autocomplete.addListener('place_changed', onPlaceChanged);

        geocoder = new google.maps.Geocoder();

        var latlng = new google.maps.LatLng(-15.801934, 35.026139);
        var mapOptions = {
            zoom: 15,
            center: latlng
        }
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
    }

    function codeAddress() {

        const iconurl = {
            url: '/static/icons.ico',
            scaledSize: new google.maps.Size(5, 5), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
        };

        var address = document.getElementById('location_area').value;
        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status == 'OK') {
                map.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    draggable: true,
                    title: "Drag Marker",
                    // icon: iconurl
                });

                AddGeometryValues(results[0].geometry.location.lat(), results[0].geometry.location.lng())

                marker.addListener('drag', handleMarkerEvent);
                marker.addListener('dragend', handleMarkerEvent);
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function AddGeometryValues(latitude, longitude) {
        lat = document.getElementById('lat');
        lng = document.getElementById('lon');

        // Add values to fields
        lat.value = latitude
        lng.value = longitude
    }

    function handleMarkerEvent(event) {
        lat = document.getElementById('lat');
        lng = document.getElementById('lon');

        lat.value = event.latLng.lat();
        lng.value = event.latLng.lng();
    }

</script>

{% endblock content %}